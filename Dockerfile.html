# Dockerfile.html - ConfigGUI HTML Server Docker Image
# Enables deployment of HTML form generation server without Qt dependency
# Task: T078-T079 (Phase 3 Block 4)

# Build Stage: Compile the HTML server application
FROM ubuntu:22.04 AS builder

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    cmake \
    git \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /build

# Copy project source code
COPY . .

# Create build directory and configure CMake (HTML-only build, no Qt)
RUN mkdir -p build && cd build && \
    cmake -DBUILD_QT_APP=OFF \
          -DBUILD_HTML_SERVER=ON \
          -DCMAKE_BUILD_TYPE=Release \
          .. && \
    cmake --build . --parallel 4

# Runtime Stage: Minimal image with only the HTML server
FROM ubuntu:22.04

# Install only runtime dependencies (no build tools)
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy compiled executable from builder
COPY --from=builder /build/build/src/html/ConfigGUIServer /app/ConfigGUIServer

# Copy schema resources (T079)
COPY resources/schemas /app/resources/schemas

# Copy configuration resources
COPY resources/configs /app/resources/configs

# Copy HTML assets (for serving)
COPY src/html/assets /app/src/html/assets

# Expose the default port
EXPOSE 8080

# Health check to verify the server is running
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# Set environment variables
ENV CONFIGGUI_PORT=8080
ENV CONFIGGUI_HOST=0.0.0.0
ENV CONFIGGUI_SCHEMA_DIR=/app/resources/schemas
ENV CONFIGGUI_CONFIG_DIR=/app/resources/configs

# Default command: Start the ConfigGUI HTML server
# Arguments:
#  --port: Port to listen on (override with CONFIGGUI_PORT)
#  --host: Host to bind to (override with CONFIGGUI_HOST)
#  --schema-dir: Schema directory path
#  --config-dir: Configuration directory path
CMD ["/app/ConfigGUIServer", \
     "--port", "8080", \
     "--host", "0.0.0.0", \
     "--schema-dir", "/app/resources/schemas", \
     "--config-dir", "/app/resources/configs"]

# Labels for image metadata
LABEL org.opencontainers.image.title="ConfigGUI HTML Form Generator"
LABEL org.opencontainers.image.description="Web-based configuration form generator from JSON/YAML schemas"
LABEL org.opencontainers.image.version="3.0"
LABEL org.opencontainers.image.authors="ConfigGUI Project"
LABEL org.opencontainers.image.source="https://github.com/pvthanh/testSpecKit"
LABEL org.opencontainers.image.documentation="See /app/README or online documentation"

# Notes:
# - Multi-stage build reduces final image size (build tools not included in runtime)
# - BUILDKIT_INLINE_CACHE=1 recommended for layer caching
# - Minimal dependencies (no Qt, no development tools) for production deployment
# - Schema resources copied into container for self-contained deployment
# - Health check enabled for Kubernetes/Swarm orchestration
# - Environment variables allow runtime configuration without rebuilding
#
# Build: docker build -f Dockerfile.html -t configgui-html:latest .
# Run:   docker run -p 8080:8080 configgui-html:latest
# Push:  docker push registry.example.com/configgui-html:latest
